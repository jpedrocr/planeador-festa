<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planeador de Petiscos para a Festa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f4; color: #292524; }
        .category-button { transition: background-color 0.3s, color 0.3s; }
        .category-button.active { background-color: #0284c7; color: white; }
        .category-button:not(.active):hover { background-color: #e0f2fe; color: #0369a1; }
        .dish-item-container, .person-item-container { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-radius: 0.5rem; transition: background-color 0.2s; background-color: #fafaf9; }
        .dish-item-container:hover, .person-item-container:hover { background-color: #f0f0f0; }
        .dish-item-container input[type="checkbox"]:checked + span { text-decoration: line-through; color: #78716c; }
        .sticky-sidebar { position: -webkit-sticky; position: sticky; top: 1rem; }
        .search-image-button, .remove-person-button, .email-person-button { flex-shrink: 0; margin-left: 0.5rem; }
        .input-field { border-color: #d6d3d1; }
        .input-field:focus { border-color: #0284c7; box-shadow: 0 0 0 2px rgba(2, 132, 199, 0.2); }
        .person-assignment-select { margin-left: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; border: 1px solid #d6d3d1; font-size: 0.875rem; background-color: white; }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-700">Planeador de Petiscos para a Festa</h1>
            <p class="text-stone-600 mt-2">Selecione, adicione pratos, gira pessoas, distribua, envie e guarde!</p>
        </header>

        <div class="lg:flex lg:gap-8">
            <main class="lg:w-2/3">
                <section id="managePeopleSection" class="mb-8 p-6 bg-white rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-sky-600 mb-4">Gerir Pessoas para as Compras</h2>
                    <form id="addPersonForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 items-end">
                        <div class="md:col-span-1">
                            <label for="newPersonName" class="block text-sm font-medium text-stone-700">Nome:</label>
                            <input type="text" id="newPersonName" name="newPersonName" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm input-field">
                        </div>
                        <div class="md:col-span-1">
                            <label for="newPersonEmail" class="block text-sm font-medium text-stone-700">E-mail (opcional):</label>
                            <input type="email" id="newPersonEmail" name="newPersonEmail" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm input-field">
                        </div>
                        <button type="submit" class="md:col-span-1 bg-sky-600 hover:bg-sky-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-300 h-10">
                            Adicionar Pessoa
                        </button>
                    </form>
                    <div id="peopleListDisplay" class="space-y-2">
                        <p class="text-sm text-stone-500" id="noPeoplePlaceholder">Nenhuma pessoa adicionada ainda.</p>
                    </div>
                     <p id="addPersonFeedback" class="text-sm mt-2 text-center"></p>
                </section>

                <section id="addDishSection" class="mb-8 p-6 bg-white rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-sky-600 mb-4">Adicionar Novo Petisco/Prato</h2>
                    <form id="addDishForm" class="space-y-4">
                        <div>
                            <label for="newDishName" class="block text-sm font-medium text-stone-700">Nome do Petisco:</label>
                            <input type="text" id="newDishName" name="newDishName" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm input-field">
                        </div>
                        <div>
                            <label for="newDishCategory" class="block text-sm font-medium text-stone-700">Categoria:</label>
                            <select id="newDishCategory" name="newDishCategory" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm input-field">
                            </select>
                            <p class="mt-1 text-xs text-stone-500">Ou escreva uma nova categoria abaixo:</p>
                            <input type="text" id="newDishCustomCategory" name="newDishCustomCategory" placeholder="Nova Categoria (opcional)" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm input-field">
                        </div>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-300">
                            Adicionar Petisco
                        </button>
                    </form>
                    <p id="addDishFeedback" class="text-sm text-green-600 mt-2 text-center"></p>
                </section>

                <div id="categoryButtons" class="mb-6 flex flex-wrap gap-2 justify-center">
                </div>

                <div id="dishesList" class="space-y-6">
                </div>
            </main>

            <aside class="lg:w-1/3 mt-8 lg:mt-0">
                <div class="sticky-sidebar card bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold text-sky-600 mb-4">Lista de Compras</h2>
                    <div id="shoppingListContainer" class="mb-6 max-h-[calc(100vh-28rem)] overflow-y-auto">
                         <p id="emptyListPlaceholder" class="text-stone-500">Nenhum item selecionado.</p>
                    </div>
                    <button id="copyButton" class="w-full mb-3 bg-sky-600 hover:bg-sky-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-300 disabled:opacity-50" disabled>
                        Copiar Lista Completa
                    </button>
                    <p id="copyFeedback" class="text-sm text-green-600 mt-2 text-center mb-4"></p>

                    <div class="mt-6 pt-6 border-t border-stone-200">
                        <h3 class="text-lg font-semibold text-stone-700 mb-3">Gestão de Dados</h3>
                        <button id="exportButton" class="w-full mb-2 bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-300">
                            Exportar Dados
                        </button>
                        <label for="importInput" class="w-full cursor-pointer inline-block text-center bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-300">
                            Importar Dados
                        </label>
                        <input type="file" id="importInput" class="hidden" accept=".json">
                        <p id="importFeedback" class="text-sm mt-2 text-center"></p>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        let dishesData = [];
        let categories = [];
        let selectedDishes = [];
        let people = []; // Array para armazenar objetos {name: string, email: string | null}
        let currentFilter = "Todos";

        const initialDishesData = [
            { id: "caldo_verde", name: "Caldo Verde", category: "Sopas e Caldos", assignedTo: null },
            { id: "canja_galinha", name: "Canja de Galinha", category: "Sopas e Caldos", assignedTo: null },
            { id: "sopa_peixe_rica", name: "Sopa de Peixe Rica", category: "Sopas e Caldos", assignedTo: null },
            { id: "bolinhos_bacalhau", name: "Bolinhos de Bacalhau", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "pataniscas_bacalhau", name: "Pataniscas de Bacalhau", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "pataniscas_polvo", name: "Pataniscas de Polvo", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "punheta_bacalhau", name: "Punheta de Bacalhau", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "filetes_polvo", name: "Filetes de Polvo", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "salada_polvo", name: "Salada de Polvo", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "ameijoas_lingueirao_bulhao_pato", name: "Amêijoas ou lingueirão à Bulhão Pato", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "berbigao_bulhao_pato_natural", name: "Berbigão à Bulhão Pato ou ao Natural", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "mexilhoes", name: "Mexilhões (ao natural, vinagrete, à espanhola, etc.)", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "camaroes", name: "Camarões (ao alhinho, cozidos, panados)", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "percebes_cozidos", name: "Percebes Cozidos", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "lapas_grelhadas", name: "Lapas Grelhadas", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "navalhas_grelhadas_bulhao_pato", name: "Navalhas Grelhadas ou à Bulhão Pato", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "ostras_natural", name: "Ostras ao Natural", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "vieiras_salteadas_gratinadas", name: "Vieiras Salteadas ou Gratinadas (em doses pequenas)", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "sapateira_recheada_pasta", name: "Sapateira Recheada (a pasta)", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "choquinhos_fritos_chocos_fritos", name: "Choquinhos Fritos (ou Chocos Fritos)", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "jaquinzinhos_petingas_fritos", name: "Jaquinzinhos (Petingas) Fritos com Molho de Escabeche (ou sem)", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "conservas_peixe_gourmet", name: "Conservas de Peixe Gourmet", category: "Do Mar (Nacional)", assignedTo: null },
            { id: "rojoes", name: "Rojões à Moda do Porto / à Minhota", category: "Da Terra (Carnes - Nacional)", assignedTo: null },
            { id: "tripas_moda_porto", name: "Tripas à Moda do Porto (em pequenas doses)", category: "Da Terra (Carnes - Nacional)", assignedTo: null },
            { id: "posta_mirandesa", name: "Posta Mirandesa (fatiada ou em mini doses)", category: "Da Terra (Carnes - Nacional)", assignedTo: null },
            { id: "pica_pau", name: "Pica-Pau (à moda do Porto)", category: "Da Terra (Carnes - Nacional)", assignedTo: null },
            { id: "carne_porco_alentejana", name: "Carne de Porco à Alentejana (com amêijoas)", category: "Da Terra (Carnes - Nacional)", assignedTo: null },
            { id: "moelas_estufadas", name: "Moelas Estufadas", category: "Da Terra (Carnes - Nacional)", assignedTo: null },
            { id: "orelheira_porco_molho_verde", name: "Orelheira de Porco com Molho Verde", category: "Da Terra (Carnes - Nacional)", assignedTo: null },
            { id: "panados", name: "Panados (de porco, frango ou peru, em tiras ou miniaturas)", category: "Da Terra (Carnes - Nacional)", assignedTo: null },
            { id: "alheiras", name: "Alheiras (de Mirandela, Vinhais, caça)", category: "Enchidos e Presuntos (Nacional)", assignedTo: null },
            { id: "chourico_assado_grelhado", name: "Chouriço Assado/Grelhado", category: "Enchidos e Presuntos (Nacional)", assignedTo: null },
            { id: "morcela_assada_grelhada", name: "Morcela Assada/Grelhada", category: "Enchidos e Presuntos (Nacional)", assignedTo: null },
            { id: "farinheira", name: "Farinheira (com ovos mexidos ou simplesmente salteada)", category: "Enchidos e Presuntos (Nacional)", assignedTo: null },
            { id: "linguica_grelhada_salteada", name: "Linguiça Grelhada/Salteada", category: "Enchidos e Presuntos (Nacional)", assignedTo: null },
            { id: "salpicao", name: "Salpicão (de Lamego, Vinhais)", category: "Enchidos e Presuntos (Nacional)", assignedTo: null },
            { id: "chourica_carne_sangue", name: "Chouriça de Carne / de Sangue", category: "Enchidos e Presuntos (Nacional)", assignedTo: null },
            { id: "butelo_casulas", name: "Butelo com Casulas (Butelo fatiado)", category: "Enchidos e Presuntos (Nacional)", assignedTo: null },
            { id: "presunto", name: "Presunto (Chaves, Lamego, Bísaro)", category: "Enchidos e Presuntos (Nacional)", assignedTo: null },
            { id: "queijo_terrincho", name: "Queijo Terrincho (Trás-os-Montes)", category: "Queijos (Nacional)", assignedTo: null },
            { id: "queijos_vaca_ovelha_cabra_norte", name: "Queijos de Vaca, Ovelha e Cabra (diversos produtores do Norte)", category: "Queijos (Nacional)", assignedTo: null },
            { id: "queijos_acores", name: "Queijos dos Açores (ex: Queijo de São Jorge, Queijo da Ilha)", category: "Queijos (Nacional)", assignedTo: null },
            { id: "queijo_serra_azeitao", name: "Queijo da Serra / Azeitão", category: "Queijos (Nacional)", assignedTo: null },
            { id: "queijo_fresco_temperado_requeijao_ervas", name: "Queijo Fresco Temperado ou Requeijão com Ervas", category: "Queijos (Nacional)", assignedTo: null },
            { id: "rissois", name: "Rissóis (carne, camarão, pescada)", category: "Fritos e Salgados (Nacional)", assignedTo: null },
            { id: "croquetes_carne", name: "Croquetes de Carne", category: "Fritos e Salgados (Nacional)", assignedTo: null },
            { id: "empadas_portuguesas", name: "Empadas Portuguesas (galinha, vitela, em formato mini)", category: "Fritos e Salgados (Nacional)", assignedTo: null },
            { id: "empanadas_galego_argentino", name: "Empanadas (estilo galego/argentino, com recheios variados)", category: "Fritos e Salgados (Nacional)", assignedTo: null },
            { id: "bola_lamego", name: "Bola de Lamego (fatiada)", category: "Fritos e Salgados (Nacional)", assignedTo: null },
            { id: "folar_chaves", name: "Folar de Chaves (fatiado)", category: "Fritos e Salgados (Nacional)", assignedTo: null },
            { id: "salmao_fumado_gravadlax", name: "Salmão Fumado (Gravadlax ou Rökt Lax)", category: "Produtos Suecos/Nórdicos", assignedTo: null },
            { id: "arenque_marinado_inlagd_sill", name: "Arenque Marinado (Inlagd Sill)", category: "Produtos Suecos/Nórdicos", assignedTo: null },
            { id: "knackebrod", name: "Knäckebröd (Pão Crocante Sueco)", category: "Produtos Suecos/Nórdicos", assignedTo: null },
            { id: "almondegas_suecas_kottbullar", name: "Almôndegas Suecas (Köttbullar)", category: "Produtos Suecos/Nórdicos", assignedTo: null },
            { id: "endro_dill", name: "Endro (Dill)", category: "Produtos Suecos/Nórdicos", assignedTo: null },
            { id: "pao_centeio_escuro_ragbrod", name: "Pão de Centeio Escuro (Rågbröd)", category: "Produtos Suecos/Nórdicos", assignedTo: null },
            { id: "compotas_artesanais_pt", name: "Compotas Artesanais Portuguesas (Figo, Abóbora com Noz, Tomate, Pimento Vermelho)", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "compota_lingonberry_lingonsylt", name: "Compota de Lingonberry (Lingonsylt)", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "mel_qualidade_artesanal", name: "Mel de Qualidade Artesanal (ex: Rosmaninho, Urze)", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "mostardas_artesanais_diferenciadas", name: "Mostardas Artesanais ou Diferenciadas", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "molho_iogurte_hortela", name: "Molho de Iogurte com Hortelã", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "molho_cocktail", name: "Molho Cocktail", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "mostarda_doce_endro_hovmastarsas", name: "Mostarda Doce com Endro (Hovmästarsås)", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "maionese_alho_ervas", name: "Maionese de Alho ou Ervas", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "pate_sardinha_atum_delicias_mar_pt", name: "Patés Portugueses (Sardinha, Atum, Delícias do Mar)", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "queijo_creme_ervas_farskost", name: "Queijo Creme com Ervas (Färskost med Örter)", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "humus", name: "Húmus (clássico, de beterraba, de pimento)", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "tapenade", name: "Tapenade (pasta de azeitonas)", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "pate_figado", name: "Paté de Fígado", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "pate_alheira", name: "Paté de Alheira", category: "Compotas, Molhos, Pastas e Patés", assignedTo: null },
            { id: "espetadinhas_caprese", name: "Espetadinhas Caprese", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "palitos_vegetais_crocantes", name: "Palitos de Vegetais Crocantes (Cenoura, pepino, aipo, pimento)", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "tomates_cherry_temperados", name: "Tomates Cherry Temperados", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "tomate_cereja_assado", name: "Tomate Cereja Assado", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "pimentos_padron_salteados", name: "Pimentos Padrón Salteados com Flor de Sal", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "espetadinhas_fruta_coloridas", name: "Espetadinhas de Fruta Coloridas", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "azeitonas_especiais", name: "Azeitonas Especiais (recheadas, de diferentes variedades)", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "tremocos", name: "Tremoços", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "pickles_variados", name: "Pickles Variados", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "cogumelos_frescos_salteados", name: "Cogumelos Frescos de Qualidade (Pleurotus, Shiitake) Salteados com Alho", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "pepino_conserva_doce_pressgurka", name: "Pepino em Conserva Doce (Pressgurka)", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "frutos_secos_sementes", name: "Frutos Secos e Sementes (Nozes, amêndoas, cajus, passas, arandos)", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "tamaras", name: "Tâmaras (simples ou recheadas)", category: "Frescos, Vegetais e Frutos Secos", assignedTo: null },
            { id: "mini_pasteis_nata", name: "Mini Pastéis de Nata", category: "Pastelaria e Sobremesas", assignedTo: null },
            { id: "mini_queijadas", name: "Mini Queijadas (de Sintra, de Leite, etc.)", category: "Pastelaria e Sobremesas", assignedTo: null },
            { id: "docaria_conventual_regional_miniatura", name: "Doçaria Conventual ou Regional em Miniatura", category: "Pastelaria e Sobremesas", assignedTo: null },
            { id: "miniaturas_tartes_fruta_fresca", name: "Miniaturas de Tartes de Fruta Fresca", category: "Pastelaria e Sobremesas", assignedTo: null },
            { id: "mousse_chocolate_copinhos", name: "Mousse de Chocolate (em copinhos individuais)", category: "Pastelaria e Sobremesas", assignedTo: null },
            { id: "salada_frutas_frescas_epoca", name: "Salada de Frutas Frescas da Época", category: "Pastelaria e Sobremesas", assignedTo: null },
            { id: "mini_pizzas", name: "Mini Pizzas", category: "Pastelaria e Sobremesas", assignedTo: null },
            { id: "macarons", name: "Macarons", category: "Pastelaria e Sobremesas", assignedTo: null },
            { id: "bolachas_finas_caramelo_salgado_chocolate", name: "Bolachas Finas com Caramelo Salgado ou Gotas de Chocolate", category: "Pastelaria e Sobremesas", assignedTo: null },
            { id: "brigadeiros", name: "Brigadeiros", category: "Pastelaria e Sobremesas", assignedTo: null },
            { id: "bolo_aniversario_filipa", name: "Bolo de Aniversário da Filipa!", category: "Pastelaria e Sobremesas", assignedTo: null },
            { id: "broa_avintes_milho", name: "Broa de Avintes / Broa de Milho (simples ou recheada)", category: "Pães e Acompanhamentos", assignedTo: null },
            { id: "pao_centeio", name: "Pão de Centeio", category: "Pães e Acompanhamentos", assignedTo: null },
            { id: "pao_regional", name: "Pão Regional (ex: Regueifa, Pão com Chouriço)", category: "Pães e Acompanhamentos", assignedTo: null },
            { id: "pao_rustico_variado", name: "Pão Rústico Variado (Alentejano, Mafra, etc.)", category: "Pães e Acompanhamentos", assignedTo: null },
            { id: "pao_alho", name: "Pão de Alho", category: "Pães e Acompanhamentos", assignedTo: null },
            { id: "focaccias", name: "Focaccias (simples, com alecrim, tomate cereja e azeitonas)", category: "Pães e Acompanhamentos", assignedTo: null },
            { id: "tostas_finas_gressinos", name: "Tostas Finas e Gressinos", category: "Pães e Acompanhamentos", assignedTo: null },
            { id: "biscoitos_salgados_artesanais", name: "Biscoitos Salgados Artesanais (ex: de azeite e alecrim)", category: "Pães e Acompanhamentos", assignedTo: null }
        ];

        const categoryButtonsContainer = document.getElementById('categoryButtons');
        const dishesListContainer = document.getElementById('dishesList');
        const shoppingListContainer = document.getElementById('shoppingListContainer');
        const copyButton = document.getElementById('copyButton');
        const copyFeedback = document.getElementById('copyFeedback');
        
        const addDishForm = document.getElementById('addDishForm');
        const newDishCategorySelect = document.getElementById('newDishCategory');
        const addDishFeedback = document.getElementById('addDishFeedback');

        const addPersonForm = document.getElementById('addPersonForm');
        const peopleListDisplay = document.getElementById('peopleListDisplay');
        const noPeoplePlaceholder = document.getElementById('noPeoplePlaceholder');
        const addPersonFeedback = document.getElementById('addPersonFeedback');

        const exportButton = document.getElementById('exportButton');
        const importInput = document.getElementById('importInput');
        const importFeedback = document.getElementById('importFeedback');

        function initializeApp() {
            loadDataFromLocalStorage();
            populateCategorySelect();
            renderCategoryButtons();
            renderDishes(currentFilter);
            updateShoppingList();
            renderPeopleList();
        }
        
        function getCategories() {
            return [...new Set(dishesData.map(dish => dish.category))];
        }

        function populateCategorySelect() {
            newDishCategorySelect.innerHTML = '<option value="">Selecione uma categoria existente</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                newDishCategorySelect.appendChild(option);
            });
        }

        function renderCategoryButtons() {
            categories = getCategories();
            categoryButtonsContainer.innerHTML = `<button data-category="Todos" class="category-button active bg-sky-600 text-white py-2 px-4 rounded-md text-sm">Todos</button>`;
            categories.forEach(category => {
                const button = document.createElement('button');
                button.dataset.category = category;
                button.textContent = category;
                button.className = "category-button bg-white hover:bg-sky-100 text-sky-700 py-2 px-4 rounded-md border border-sky-300 text-sm";
                categoryButtonsContainer.appendChild(button);
            });
        }
        
        function renderPeopleList() {
            peopleListDisplay.innerHTML = '';
            const placeholder = document.getElementById('noPeoplePlaceholder');
            if (people.length === 0) {
                 if (placeholder) placeholder.style.display = 'block';
            } else {
                if (placeholder) placeholder.style.display = 'none';
                const list = document.createElement('ul');
                list.className = 'space-y-1';
                people.forEach((personObj, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'person-item-container text-sm text-stone-600';
                    
                    const personInfoDiv = document.createElement('div');
                    personInfoDiv.className = 'flex-grow min-w-0';
                    const personNameSpan = document.createElement('span');
                    personNameSpan.textContent = personObj.name;
                    personNameSpan.className = "font-medium";
                    personInfoDiv.appendChild(personNameSpan);

                    if (personObj.email) {
                        const personEmailSpan = document.createElement('span');
                        personEmailSpan.textContent = ` (${personObj.email})`;
                        personEmailSpan.className = "text-xs text-stone-500 ml-1 truncate";
                        personInfoDiv.appendChild(personEmailSpan);
                    }
                    listItem.appendChild(personInfoDiv);

                    const removeButton = document.createElement('button');
                    removeButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.362 15h5.276a1.5 1.5 0 0 0 1.497-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.25-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5ZM4.504 5.5l.815 8.15a.25.25 0 0 0 .249.225h5.276a.25.25 0 0 0 .249-.225l.815-8.15H4.504Z" clip-rule="evenodd" /></svg>`;
                    removeButton.className = 'remove-person-button text-red-500 hover:text-red-700 p-1 rounded-full';
                    removeButton.title = `Remover ${personObj.name}`;
                    removeButton.onclick = () => removePerson(index);
                    listItem.appendChild(removeButton);

                    list.appendChild(listItem);
                });
                peopleListDisplay.appendChild(list);
            }
            renderDishes(currentFilter); 
            updateShoppingList(); 
        }

        function removePerson(indexToRemove) {
            const removedPersonName = people[indexToRemove].name;
            people.splice(indexToRemove, 1);
            
            selectedDishes.forEach(dish => {
                if (dish.assignedTo === removedPersonName) {
                    dish.assignedTo = null; 
                }
            });
            renderPeopleList();
            saveDataToLocalStorage();
        }

        function renderDishes(filter = "Todos") {
            currentFilter = filter;
            dishesListContainer.innerHTML = '';
            const filteredDishes = filter === "Todos" ? dishesData : dishesData.filter(dish => dish.category === filter);

            const dishesByCategory = filteredDishes.reduce((acc, dish) => {
                if (!acc[dish.category]) {
                    acc[dish.category] = [];
                }
                acc[dish.category].push(dish);
                return acc;
            }, {});

            for (const category in dishesByCategory) {
                const categorySection = document.createElement('div');
                categorySection.className = 'mb-8 p-6 bg-white rounded-lg shadow-md';
                
                const categoryTitle = document.createElement('h3');
                categoryTitle.className = 'text-xl font-semibold text-sky-600 mb-4 border-b border-stone-200 pb-2';
                categoryTitle.textContent = category;
                categorySection.appendChild(categoryTitle);

                const itemsGrid = document.createElement('div');
                itemsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4';

                dishesByCategory[category].forEach(dish => {
                    const itemContainer = document.createElement('div');
                    itemContainer.className = 'dish-item-container shadow-sm';

                    const checkboxAndName = document.createElement('div');
                    checkboxAndName.className = 'flex items-center flex-grow min-w-0';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `dish-${dish.id}`;
                    checkbox.value = dish.id;
                    checkbox.className = 'mr-3 h-5 w-5 text-sky-600 border-stone-300 rounded focus:ring-sky-500 flex-shrink-0';
                    const selectedDish = selectedDishes.find(d => d.id === dish.id);
                    if (selectedDish) {
                        checkbox.checked = true;
                    }
                    checkbox.addEventListener('change', (event) => handleDishSelection(event, dish));
                    
                    const span = document.createElement('span');
                    span.textContent = dish.name;
                    span.className = 'text-stone-700 cursor-pointer truncate';
                    span.title = dish.name; 
                    span.onclick = () => checkbox.click();

                    checkboxAndName.appendChild(checkbox);
                    checkboxAndName.appendChild(span);
                    itemContainer.appendChild(checkboxAndName);
                    
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'flex items-center flex-shrink-0';

                    const personSelect = document.createElement('select');
                    personSelect.className = 'person-assignment-select';
                    personSelect.id = `person-select-${dish.id}`;
                    personSelect.style.display = selectedDish ? 'inline-block' : 'none';
                    
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "Atribuir...";
                    personSelect.appendChild(defaultOption);
                    
                    people.forEach(personObj => {
                        const option = document.createElement('option');
                        option.value = personObj.name;
                        option.textContent = personObj.name;
                        personSelect.appendChild(option);
                    });
                    if (selectedDish && selectedDish.assignedTo) {
                        personSelect.value = selectedDish.assignedTo;
                    }
                    personSelect.addEventListener('change', (event) => handlePersonAssignment(dish.id, event.target.value));
                    controlsDiv.appendChild(personSelect);

                    const searchButton = document.createElement('button');
                    searchButton.className = 'search-image-button bg-sky-100 hover:bg-sky-200 text-sky-600 font-medium py-1 px-2.5 rounded-md text-xs flex items-center';
                    searchButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 mr-1"><path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" /></svg>`;
                    searchButton.addEventListener('click', () => {
                        window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(dish.name)}`, '_blank');
                    });
                    controlsDiv.appendChild(searchButton);
                    itemContainer.appendChild(controlsDiv);
                    
                    itemsGrid.appendChild(itemContainer);
                });
                categorySection.appendChild(itemsGrid);
                dishesListContainer.appendChild(categorySection);
            }
            updateActiveCategoryButton();
        }
        
        function updateActiveCategoryButton() {
            document.querySelectorAll('#categoryButtons button').forEach(button => {
                if (button.dataset.category === currentFilter) {
                    button.classList.add('active', 'bg-sky-600', 'text-white');
                    button.classList.remove('bg-white', 'text-sky-700', 'border-sky-300');
                } else {
                    button.classList.remove('active', 'bg-sky-600', 'text-white');
                    button.classList.add('bg-white', 'text-sky-700', 'border-sky-300');
                }
            });
        }

        function handleDishSelection(event, dish) {
            const personSelect = document.getElementById(`person-select-${dish.id}`);
            if (event.target.checked) {
                if (!selectedDishes.find(d => d.id === dish.id)) {
                    selectedDishes.push({ ...dish, assignedTo: null }); 
                }
                if(personSelect) personSelect.style.display = 'inline-block';
            } else {
                selectedDishes = selectedDishes.filter(d => d.id !== dish.id);
                 if(personSelect) personSelect.style.display = 'none';
            }
            updateShoppingList();
            saveDataToLocalStorage();
        }

        function handlePersonAssignment(dishId, personName) {
            const dishIndex = selectedDishes.findIndex(d => d.id === dishId);
            if (dishIndex > -1) {
                selectedDishes[dishIndex].assignedTo = personName === "" ? null : personName;
            }
            updateShoppingList();
            saveDataToLocalStorage();
        }

        function updateShoppingList() {
            shoppingListContainer.innerHTML = ''; 
             const placeholder = document.createElement('p');
             placeholder.id = 'emptyListPlaceholder';
             placeholder.className = 'text-stone-500';
             placeholder.textContent = 'Nenhum item selecionado.';

            if (selectedDishes.length === 0) {
                shoppingListContainer.appendChild(placeholder);
                copyButton.disabled = true;
            } else {
                const itemsByPerson = {};
                people.forEach(personObj => itemsByPerson[personObj.name] = { email: personObj.email, categories: {} });
                itemsByPerson["Não Atribuído"] = { email: null, categories: {} };


                selectedDishes.forEach(dish => {
                    const assigneeName = dish.assignedTo || "Não Atribuído";
                    if (!itemsByPerson[assigneeName]) { 
                        itemsByPerson[assigneeName] = { email: null, categories: {} };
                    }
                    if (!itemsByPerson[assigneeName].categories[dish.category]) {
                        itemsByPerson[assigneeName].categories[dish.category] = [];
                    }
                    itemsByPerson[assigneeName].categories[dish.category].push(dish.name);
                });

                let hasAnyItem = false;
                for (const personName in itemsByPerson) {
                    const personData = itemsByPerson[personName];
                    const categoriesOfPerson = personData.categories;
                    let hasItemsForThisPerson = false;
                    
                    const personSectionDiv = document.createElement('div');
                    personSectionDiv.className = 'mb-4';

                    const personHeaderDiv = document.createElement('div');
                    personHeaderDiv.className = 'flex justify-between items-center mb-1';

                    const personTitle = document.createElement('h4');
                    personTitle.textContent = personName + ":";
                    personTitle.className = "font-bold text-sky-800 text-lg";
                    personHeaderDiv.appendChild(personTitle);

                    if (personData.email && Object.values(categoriesOfPerson).some(catList => catList.length > 0)) {
                        const emailButton = document.createElement('button');
                        emailButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M2.5 3A1.5 1.5 0 0 0 1 4.5v.793c.026.009.051.02.076.032L7.674 8.51a.75.75 0 0 0 .652 0L14.924 5.325c.025-.012.05-.023.076-.032V4.5A1.5 1.5 0 0 0 13.5 3h-11Z" /><path d="M15 6.954 8.978 9.86a2.25 2.25 0 0 1-1.956 0L1 6.954V11.5A1.5 1.5 0 0 0 2.5 13h11a1.5 1.5 0 0 0 1.5-1.5V6.954Z" /></svg>`;
                        emailButton.className = 'email-person-button bg-blue-100 hover:bg-blue-200 text-blue-600 p-1.5 rounded-full text-xs';
                        emailButton.title = `Enviar lista para ${personName}`;
                        emailButton.onclick = () => sendEmailToPerson(personName, personData.email, categoriesOfPerson);
                        personHeaderDiv.appendChild(emailButton);
                    }
                    
                    const categoryListUl = document.createElement('ul');
                    categoryListUl.className = 'ml-2';

                    for (const category in categoriesOfPerson) {
                        if (categoriesOfPerson[category].length > 0) {
                            hasItemsForThisPerson = true;
                            hasAnyItem = true;
                            const categoryHeader = document.createElement('li');
                            categoryHeader.textContent = category + ":";
                            categoryHeader.className = "font-semibold mt-1 text-sky-700";
                            categoryListUl.appendChild(categoryHeader);
                            
                            const subList = document.createElement('ul');
                            subList.className = "list-disc pl-5";
                            categoriesOfPerson[category].forEach(name => {
                                const listItem = document.createElement('li');
                                listItem.textContent = name;
                                listItem.className = "text-stone-600";
                                subList.appendChild(listItem);
                            });
                            categoryListUl.appendChild(subList);
                        }
                    }
                    if (hasItemsForThisPerson) {
                        personSectionDiv.appendChild(personHeaderDiv);
                        personSectionDiv.appendChild(categoryListUl);
                        shoppingListContainer.appendChild(personSectionDiv);
                    }
                }
                 if (!hasAnyItem) {
                    shoppingListContainer.appendChild(placeholder);
                }
                copyButton.disabled = !hasAnyItem;
            }
        }

        function sendEmailToPerson(personName, email, categoriesOfPerson) {
            let subject = `Lista de Compras para a Festa da Filipa - Tarefas de ${personName}`;
            let body = `Olá ${personName},\n\nAqui está a tua lista de compras para a festa da Filipa:\n\n`;
            for (const category in categoriesOfPerson) {
                if (categoriesOfPerson[category].length > 0) {
                    body += `${category}:\n`;
                    categoriesOfPerson[category].forEach(name => {
                        body += `  - ${name}\n`;
                    });
                    body += "\n";
                }
            }
            body += "Obrigado pela ajuda!\n\n";
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_blank');
        }
        
        addPersonForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const newPersonNameInput = document.getElementById('newPersonName');
            const newPersonEmailInput = document.getElementById('newPersonEmail');
            const name = newPersonNameInput.value.trim();
            const email = newPersonEmailInput.value.trim();

            if (name && !people.find(p => p.name === name)) {
                people.push({ name, email: email || null });
                renderPeopleList();
                newPersonNameInput.value = '';
                newPersonEmailInput.value = '';
                addPersonFeedback.textContent = `"${name}" adicionado(a).`;
                addPersonFeedback.className = 'text-sm text-green-600 mt-2 text-center';
                saveDataToLocalStorage();
            } else if (people.find(p => p.name === name)) {
                addPersonFeedback.textContent = `"${name}" já existe na lista.`;
                addPersonFeedback.className = 'text-sm text-amber-600 mt-2 text-center';
            } else {
                 addPersonFeedback.textContent = 'Por favor, insira um nome válido.';
                 addPersonFeedback.className = 'text-sm text-red-600 mt-2 text-center';
            }
            setTimeout(() => { addPersonFeedback.textContent = ''; }, 3000);
        });


        addDishForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const newDishNameInput = document.getElementById('newDishName');
            const newDishCategoryValue = newDishCategorySelect.value;
            const newDishCustomCategoryInput = document.getElementById('newDishCustomCategory');

            const name = newDishNameInput.value.trim();
            let category = newDishCustomCategoryInput.value.trim();
            if (!category && newDishCategoryValue) {
                category = newDishCategoryValue;
            } else if (!category && !newDishCategoryValue) {
                addDishFeedback.textContent = 'Por favor, insira um nome e selecione ou crie uma categoria.';
                addDishFeedback.className = 'text-sm text-red-600 mt-2 text-center';
                setTimeout(() => { addDishFeedback.textContent = ''; }, 3000);
                return;
            }
             if (!name) {
                addDishFeedback.textContent = 'Por favor, insira um nome para o petisco.';
                addDishFeedback.className = 'text-sm text-red-600 mt-2 text-center';
                setTimeout(() => { addDishFeedback.textContent = ''; }, 3000);
                return;
            }

            const id = name.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
            dishesData.push({ id, name, category, assignedTo: null });

            if (!categories.includes(category)) {
                categories.push(category);
                renderCategoryButtons();
                populateCategorySelect();
            }
            
            renderDishes(currentFilter); 
            addDishFeedback.textContent = `"${name}" adicionado à categoria "${category}"!`;
            addDishFeedback.className = 'text-sm text-green-600 mt-2 text-center';
            newDishNameInput.value = '';
            newDishCustomCategoryInput.value = '';
            newDishCategorySelect.value = '';
            setTimeout(() => { addDishFeedback.textContent = ''; }, 3000);
            saveDataToLocalStorage();
        });


        categoryButtonsContainer.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                const category = event.target.dataset.category;
                renderDishes(category);
            }
        });

        copyButton.addEventListener('click', () => {
            let listText = "Lista de Compras para a Festa da Filipa:\n\n";
            const itemsByPerson = {};
            people.forEach(personObj => itemsByPerson[personObj.name] = {categories: {}});
            itemsByPerson["Não Atribuído"] = {categories: {}};

            selectedDishes.forEach(dish => {
                const assigneeName = dish.assignedTo || "Não Atribuído";
                 if (!itemsByPerson[assigneeName]) { 
                    itemsByPerson[assigneeName] = {categories: {}};
                }
                if (!itemsByPerson[assigneeName].categories[dish.category]) {
                    itemsByPerson[assigneeName].categories[dish.category] = [];
                }
                itemsByPerson[assigneeName].categories[dish.category].push(dish.name);
            });
            
            let hasContent = false;
            for (const personName in itemsByPerson) {
                 const categoriesOfPerson = itemsByPerson[personName].categories;
                 let hasItemsForThisPerson = false;
                 for(const cat in categoriesOfPerson) {
                    if (categoriesOfPerson[cat].length > 0) {
                        hasItemsForThisPerson = true;
                        break;
                    }
                 }
                if(hasItemsForThisPerson){
                    if(hasContent) listText += "\n"; 
                    listText += `${personName}:\n`;
                    hasContent = true;
                    for (const category in categoriesOfPerson) {
                        if (categoriesOfPerson[category].length > 0) {
                            listText += `  ${category}:\n`;
                            categoriesOfPerson[category].forEach(name => {
                                listText += `    - ${name}\n`;
                            });
                        }
                    }
                }
            }
            
            const textArea = document.createElement("textarea");
            textArea.value = listText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyFeedback.textContent = 'Lista copiada!';
                setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
            } catch (err) {
                copyFeedback.textContent = 'Erro ao copiar.';
                 setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
            }
            document.body.removeChild(textArea);
        });

        function saveDataToLocalStorage() {
            const dataToSave = {
                dishesData,
                people,
                selectedDishes
            };
            localStorage.setItem('festaFilipaData', JSON.stringify(dataToSave));
        }

        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem('festaFilipaData');
            if (savedData) {
                try {
                    const loadedData = JSON.parse(savedData);
                    dishesData = loadedData.dishesData || initialDishesData;
                    people = loadedData.people || [];
                    selectedDishes = loadedData.selectedDishes || [];
                } catch (e) {
                    console.error("Erro ao carregar dados guardados:", e);
                    dishesData = initialDishesData; 
                }
            } else {
                 dishesData = initialDishesData;
            }
            categories = getCategories();
        }
        
        function exportData() {
            const dataToExport = {
                dishesData,
                people,
                selectedDishes
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href",     dataStr);
            downloadAnchorNode.setAttribute("download", "festa_filipa_dados.json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.dishesData && importedData.people && importedData.selectedDishes) {
                        dishesData = importedData.dishesData;
                        people = importedData.people;
                        selectedDishes = importedData.selectedDishes;
                        
                        categories = getCategories();
                        currentFilter = "Todos"; // Reset filter

                        populateCategorySelect();
                        renderCategoryButtons();
                        renderPeopleList();
                        renderDishes(); 
                        updateShoppingList();
                        saveDataToLocalStorage(); 

                        importFeedback.textContent = 'Dados importados com sucesso!';
                        importFeedback.className = 'text-sm text-green-600 mt-2 text-center';
                    } else {
                        throw new Error("Formato de ficheiro inválido.");
                    }
                } catch (error) {
                    console.error("Erro ao importar dados:", error);
                    importFeedback.textContent = 'Erro ao importar. Ficheiro inválido.';
                    importFeedback.className = 'text-sm text-red-600 mt-2 text-center';
                } finally {
                    setTimeout(() => { importFeedback.textContent = ''; }, 3000);
                    event.target.value = null; // Reset input para permitir re-importar o mesmo ficheiro
                }
            };
            reader.readAsText(file);
        }

        exportButton.addEventListener('click', exportData);
        importInput.addEventListener('change', importData);

        initializeApp(); 
    </script>
</body>
</html>
